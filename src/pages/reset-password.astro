---
import Layout from '../layouts/Layout.astro';
import { ForgotPasswordPage } from '../components/auth/ForgotPasswordPage';
import { createSupabaseServerInstance } from '../db/supabase.client';

export const prerender = false;

// Handle PKCE flow (code exchange)
const code = Astro.url.searchParams.get('code');
if (code) {
  const supabase = createSupabaseServerInstance({
    cookies: Astro.cookies,
    headers: Astro.request.headers,
  });
  
  const { error } = await supabase.auth.exchangeCodeForSession(code);
  
  if (!error) {
    return Astro.redirect('/reset-password/change');
  } else {
    console.error('Error exchanging code for session:', error);
    // If error, redirect back to reset password page without code to try again
    return Astro.redirect('/reset-password?error=invalid_code');
  }
}
---

<Layout title="Resetuj hasÅ‚o - Discord Wannabe">
  <main class="min-h-screen flex items-center justify-center p-4 bg-background">
    <div class="w-full max-w-md">
      <ForgotPasswordPage client:load />
    </div>
  </main>
</Layout>
